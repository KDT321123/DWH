VIEW "BL.Models.ScriptModel::V_001_TEST"
AS

WITH PLAN_SUM AS (
SELECT YR,
       LPAD(MO,2,'0') AS MO,
       BUKRS,
       SUM(ZREVENUE) AS ZREVENUE
  FROM "BL.DI.Tables.S4::T_ZSAC_FINRPTBGT"
 WHERE ZDEL = 'Y'
 GROUP BY YR, MO, BUKRS
 ORDER BY BUKRS, YR, MO
),

PLAN_TMP AS (
SELECT YR,
       MO,
       BUKRS,
       ZREVENUE
  FROM PLAN_SUM
 UNION ALL
SELECT CAST((YR -1) AS NVARCHAR(4)) AS YR,
       MO,
       BUKRS,
       (ZREVENUE + MO * 0.1) AS ZREVENUE
  FROM PLAN_SUM
),

PLAN_CAL1 AS (
SELECT YR,
       MO,
       BUKRS,
       ZREVENUE,
       LAG(ZREVENUE) OVER(PARTITION BY BUKRS ORDER BY YR ASC, MO ASC) AS MOM_ZREVENUE, --环比
       LAG(ZREVENUE) OVER(PARTITION BY BUKRS, MO ORDER BY YR ASC) AS YOY_ZREVENUE, --同比
       SUM(ZREVENUE) OVER(PARTITION BY BUKRS, YR ORDER BY MO ASC) AS SUM_ZREVENUE--累计
  FROM PLAN_TMP
),

PLAN_CAL2 AS (
SELECT YR,
       MO,
       BUKRS,
       ZREVENUE,
       MOM_ZREVENUE, --环比
       YOY_ZREVENUE, --同比
       SUM_ZREVENUE, --累计
       LAG(SUM_ZREVENUE) OVER(PARTITION BY BUKRS, MO ORDER BY YR ASC) AS YOY_SUM_ZREVENUE --同比
  FROM PLAN_CAL1
)

SELECT YR, MO, BUKRS, ZREVENUE, MOM_ZREVENUE, YOY_ZREVENUE, SUM_ZREVENUE, YOY_SUM_ZREVENUE FROM PLAN_CAL2;